<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div id="app"></div>
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    currentDate: new Date(),
                    selectedMonth: new Date().getMonth(),
                    selectedYear: new Date().getFullYear(),
                    isDrawing: false,
                    isErasing: false,
                    canvas: null,
                    ctx: null,
                    chatId: null,
                    drawingData: null,
                    lastX: 0,
                    lastY: 0,
                };
            },
            mounted() {
                this.initTelegram();
                this.$nextTick(() => {
                    this.initCanvas();
                    this.loadDrawing();
                });
                window.addEventListener('resize', () => {
                    this.initCanvas();
                    this.$nextTick(() => {
                        if (this.drawingData) {
                            this.restoreDrawing();
                        }
                    });
                });
            },
            watch: {
                selectedMonth() {
                    this.$nextTick(() => {
                        this.initCanvas();
                        this.loadDrawing();
                    });
                },
                selectedYear() {
                    this.$nextTick(() => {
                        this.initCanvas();
                        this.loadDrawing();
                    });
                }
            },
            methods: {
                initTelegram() {
                    if (window.Telegram && window.Telegram.WebApp) {
                        window.Telegram.WebApp.ready();
                        window.Telegram.WebApp.expand();
                        // –ü–æ–ª—É—á–∞–µ–º chat_id –∏–∑ initData
                        const initData = window.Telegram.WebApp.initDataUnsafe;
                        if (initData && initData.user) {
                            this.chatId = initData.user.id;
                        } else {
                            // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è chat_id
                            const urlParams = new URLSearchParams(window.location.search);
                            this.chatId = parseInt(urlParams.get('chat_id')) || 0;
                        }
                    } else {
                        // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ Telegram
                        const urlParams = new URLSearchParams(window.location.search);
                        this.chatId = parseInt(urlParams.get('chat_id')) || 1;
                    }
                },
                initCanvas() {
                    this.$nextTick(() => {
                        this.canvas = this.$refs.canvas;
                        if (!this.canvas) return;
                        
                        this.ctx = this.canvas.getContext('2d');
                        this.ctx.lineCap = 'round';
                        this.ctx.lineJoin = 'round';
                        this.ctx.lineWidth = 3;
                        this.ctx.strokeStyle = '#000000';
                        
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã canvas –ø–æ —Ä–∞–∑–º–µ—Ä—É –∫–∞–ª–µ–Ω–¥–∞—Ä—è
                        const calendarGrid = this.$refs.calendarGrid;
                        if (calendarGrid) {
                            const rect = calendarGrid.getBoundingClientRect();
                            this.canvas.width = rect.width;
                            this.canvas.height = rect.height;
                        }
                    });
                },
                async loadDrawing() {
                    if (!this.ctx || !this.canvas) {
                        await this.$nextTick();
                        this.initCanvas();
                    }
                    try {
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∏—Å—É–Ω–æ–∫ –∏–∑ localStorage
                        const storageKey = `drawing_${this.chatId}_${this.selectedYear}_${this.selectedMonth + 1}`;
                        const savedData = localStorage.getItem(storageKey);
                        
                        if (savedData) {
                            this.drawingData = savedData;
                            await this.$nextTick();
                            this.restoreDrawing();
                        } else {
                            // –û—á–∏—â–∞–µ–º canvas –µ—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Ä–∏—Å—É–Ω–∫–∞
                            // Canvas –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π, —Ç–∞–∫ —á—Ç–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—å –±—É–¥–µ—Ç –≤–∏–¥–µ–Ω
                            if (this.ctx && this.canvas) {
                                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                            }
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∏—Å—É–Ω–∫–∞:', error);
                    }
                },
                restoreDrawing() {
                    if (!this.drawingData || !this.ctx || !this.canvas) return;
                    const img = new Image();
                    img.onload = () => {
                        // –ù–µ –æ—á–∏—â–∞–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é, —á—Ç–æ–±—ã –∫–∞–ª–µ–Ω–¥–∞—Ä—å –±—ã–ª –≤–∏–¥–µ–Ω
                        // –ü—Ä–æ—Å—Ç–æ —Ä–∏—Å—É–µ–º –ø–æ–≤–µ—Ä—Ö
                        this.ctx.drawImage(img, 0, 0, this.canvas.width, this.canvas.height);
                    };
                    img.onerror = () => {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                    };
                    img.src = this.drawingData;
                },
                getEventPos(event) {
                    const rect = this.canvas.getBoundingClientRect();
                    if (event.touches && event.touches.length > 0) {
                        return {
                            x: event.touches[0].clientX - rect.left,
                            y: event.touches[0].clientY - rect.top
                        };
                    }
                    return {
                        x: event.clientX - rect.left,
                        y: event.clientY - rect.top
                    };
                },
                startDrawing(event) {
                    event.preventDefault();
                    this.isDrawing = true;
                    const pos = this.getEventPos(event);
                    this.lastX = pos.x;
                    this.lastY = pos.y;
                },
                draw(event) {
                    if (!this.isDrawing) return;
                    event.preventDefault();
                    
                    const pos = this.getEventPos(event);
                    const currentX = pos.x;
                    const currentY = pos.y;

                    this.ctx.beginPath();
                    this.ctx.moveTo(this.lastX, this.lastY);
                    this.ctx.lineTo(currentX, currentY);
                    
                    if (this.isErasing) {
                        this.ctx.globalCompositeOperation = 'destination-out';
                        this.ctx.lineWidth = 20;
                    } else {
                        this.ctx.globalCompositeOperation = 'source-over';
                        this.ctx.lineWidth = 3;
                    }
                    
                    this.ctx.stroke();
                    this.ctx.closePath();

                    this.lastX = currentX;
                    this.lastY = currentY;
                },
                stopDrawing() {
                    if (this.isDrawing) {
                        this.isDrawing = false;
                        this.saveDrawing();
                    }
                },
                saveDrawing() {
                    try {
                        const dataUrl = this.canvas.toDataURL();
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∏—Å—É–Ω–æ–∫ –≤ localStorage
                        const storageKey = `drawing_${this.chatId}_${this.selectedYear}_${this.selectedMonth + 1}`;
                        localStorage.setItem(storageKey, dataUrl);
                        this.drawingData = dataUrl;
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∏—Å—É–Ω–∫–∞:', error);
                        // –ï—Å–ª–∏ localStorage –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                        if (error.name === 'QuotaExceededError') {
                            alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –û—á–∏—Å—Ç–∏—Ç–µ —Å—Ç–∞—Ä—ã–µ —Ä–∏—Å—É–Ω–∫–∏.');
                        }
                    }
                },
                toggleDrawing() {
                    this.isDrawing = false;
                    this.isErasing = false;
                    this.ctx.globalCompositeOperation = 'source-over';
                    this.ctx.lineWidth = 3;
                },
                toggleErasing() {
                    this.isDrawing = false;
                    this.isErasing = true;
                    this.ctx.globalCompositeOperation = 'destination-out';
                    this.ctx.lineWidth = 20;
                },
                clearCanvas() {
                    if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å —Ä–∏—Å—É–Ω–æ–∫?')) {
                        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                        this.saveDrawing();
                    }
                },
                prevMonth() {
                    if (this.selectedMonth === 0) {
                        this.selectedMonth = 11;
                        this.selectedYear--;
                    } else {
                        this.selectedMonth--;
                    }
                    this.drawingData = null;
                    this.loadDrawing();
                },
                nextMonth() {
                    if (this.selectedMonth === 11) {
                        this.selectedMonth = 0;
                        this.selectedYear++;
                    } else {
                        this.selectedMonth++;
                    }
                    this.drawingData = null;
                    this.loadDrawing();
                },
                getMonthName(month) {
                    const months = [
                        '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
                        '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
                    ];
                    return months[month];
                },
                getDaysInMonth(year, month) {
                    return new Date(year, month + 1, 0).getDate();
                },
                getFirstDayOfMonth(year, month) {
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è –º–µ—Å—è—Ü–∞ (0 = –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ, 1 = –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, ...)
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Ñ–æ—Ä–º–∞—Ç –≥–¥–µ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ = 0
                    const day = new Date(year, month, 1).getDay();
                    return day === 0 ? 6 : day - 1; // –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ = 0
                },
                getCalendarDays() {
                    const daysInMonth = this.getDaysInMonth(this.selectedYear, this.selectedMonth);
                    const firstDay = this.getFirstDayOfMonth(this.selectedYear, this.selectedMonth);
                    const days = [];
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –¥–ª—è –¥–Ω–µ–π –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
                    for (let i = 0; i < firstDay; i++) {
                        days.push(null);
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –¥–Ω–∏ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
                    for (let day = 1; day <= daysInMonth; day++) {
                        days.push(day);
                    }
                    
                    return days;
                },
                getWeekDays() {
                    return ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
                },
            },
            template: `
                <div class="min-h-screen bg-gray-100 p-4">
                    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-4">
                        <div class="mb-4 flex items-center justify-between">
                            <button @click="prevMonth" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                ‚Üê
                            </button>
                            <h2 class="text-2xl font-bold">{{ getMonthName(selectedMonth) }} {{ selectedYear }}</h2>
                            <button @click="nextMonth" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                ‚Üí
                            </button>
                        </div>
                        
                        <div class="mb-4 flex gap-2 justify-center">
                            <button 
                                @click="toggleDrawing"
                                :class="['px-4 py-2 rounded', !isErasing ? 'bg-green-500 text-white' : 'bg-gray-300']">
                                ‚úèÔ∏è –†–∏—Å–æ–≤–∞—Ç—å
                            </button>
                            <button 
                                @click="toggleErasing"
                                :class="['px-4 py-2 rounded', isErasing ? 'bg-red-500 text-white' : 'bg-gray-300']">
                                üßπ –õ–∞—Å—Ç–∏–∫
                            </button>
                            <button 
                                @click="clearCanvas"
                                class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">
                                üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
                            </button>
                        </div>

                        <div class="border-2 border-gray-300 rounded-lg overflow-hidden relative" ref="calendarGrid">
                            <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
                            <div class="bg-white">
                                <!-- –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ -->
                                <div class="grid grid-cols-7 border-b border-gray-300">
                                    <div v-for="day in getWeekDays()" :key="day" 
                                         class="p-2 text-center font-semibold text-gray-700 bg-gray-50 border-r border-gray-300 last:border-r-0">
                                        {{ day }}
                                    </div>
                                </div>
                                
                                <!-- –ß–∏—Å–ª–∞ –º–µ—Å—è—Ü–∞ -->
                                <div class="grid grid-cols-7">
                                    <div v-for="(day, index) in getCalendarDays()" :key="index"
                                         class="aspect-square border-r border-b border-gray-300 last:border-r-0 bg-white relative"
                                         :class="{'bg-gray-50': day === null}">
                                        <span v-if="day !== null" class="absolute top-1 left-1 text-sm font-medium text-gray-700">
                                            {{ day }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Canvas –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –ø–æ–≤–µ—Ä—Ö –∫–∞–ª–µ–Ω–¥–∞—Ä—è -->
                            <canvas
                                ref="canvas"
                                @mousedown="startDrawing"
                                @mousemove="draw"
                                @mouseup="stopDrawing"
                                @mouseleave="stopDrawing"
                                @touchstart.prevent="startDrawing"
                                @touchmove.prevent="draw"
                                @touchend.prevent="stopDrawing"
                                class="absolute top-0 left-0 w-full h-full cursor-crosshair pointer-events-auto"
                                style="touch-action: none;"
                            ></canvas>
                        </div>
                    </div>
                </div>
            `,
        }).mount('#app');
    </script>
</body>
</html>
